#!/usr/bin/env python3.5

import sys
import rdflib
from rdflib import Literal, Namespace

################################################################### helpers ####

def create_dummy_value ():
    global counter
    result = Literal('dummy_literal%d' % counter)
    counter += 1
    return result

###################################################################### main ####

# guard: commandline arguments
if len(sys.argv) != 3:
    print('Syntax: %s INPUT_FILENAME OUTPUT_FILENAME' % sys.argv[0])
    print('        %s ../../GroundTruth/building_instances/gtc_brick.ttl buildings/gth.ttl' % sys.argv[0])
    print('        %s ../../ou44-brick/src/sdu_ou44_brick.ttl buildings/ou44.ttl' % sys.argv[0])
    exit()
ifilename = sys.argv[1]
ofilename = sys.argv[2]
counter = 1

# load input
g = rdflib.Graph()
g.parse(ifilename, format='turtle')
initial_relation_count = len(g)

# load extension
g.parse('brick-data.ttl', format='turtle')
BD     = Namespace('https://brickschema.org/schema/1.0.1/BrickData#')
BDSMAP = Namespace('https://brickschema.org/schema/1.0.1/BrickDataSmap#')
BDS    = Namespace('https://brickschema.org/schema/1.0.1/BrickDataStatic#')
RDF    = Namespace('http://www.w3.org/1999/02/22-rdf-syntax-ns#')
RDFS   = Namespace('http://www.w3.org/2000/01/rdf-schema#')
DATA   = Namespace('http://mmmi.sdu.dk/1.0.1/buildings/ou44/data#')
BDPTL  = Namespace('http://mmmi.sdu.dk/1.0.1/buildings/ou44/bd_pt_l#')
BDPTS  = Namespace('http://mmmi.sdu.dk/1.0.1/buildings/ou44/bd_pt_s#')
g.bind('rdf'  , RDF)
g.bind('rdfs' , RDFS)
g.bind('data' , DATA)
g.bind('bdptl', BDPTL)
g.bind('bdpts', BDPTS)

# create archiver
archiver = DATA['archiver']
g.add( (archiver, RDF.type      , BDSMAP['Archiver']) )
g.add( (archiver, BDSMAP.add    , create_dummy_value()) )
g.add( (archiver, BDSMAP.query  , create_dummy_value()) )
g.add( (archiver, BDSMAP.version, create_dummy_value()) )

# create lighting modeling approach
LightingThresholdProperty = BDPTL['ThresholdProperty']
g.add( (LightingThresholdProperty, RDFS.subClassOf, BD['Property']) )
LightingApproach = BDPTL['Approach']
g.add( (LightingApproach, RDF.type, BD['Approach']) )
hasPropertyLightingThreshold = BDPTL['hasPropertyThreshold']
g.add( (hasPropertyLightingThreshold, RDFS.subClassOf, BD['hasProperty']) )
hasPropertyLightingMaxOccupants = BDPTL['hasPropertyMaxOccupants']
g.add( (hasPropertyLightingMaxOccupants, RDFS.subClassOf, BD['hasProperty']) )

# attach metering properties and streams
q = '''
SELECT ?meter
WHERE {
    ?meter rdf:type/rdfs:subClassOf* brick:Power_Meter .
}
'''
meters = sorted(g.query(q))
for row in meters:
    meter = row[0]
    
    # attach data stream
    data = DATA['meter/data%d' % counter]
    counter += 1
    g.add( (data, RDF.type      , BDSMAP['Data']) )
    g.add( (meter, BDSMAP.hasData, data) )
    g.add( (data, BDSMAP.uuid, create_dummy_value()) )
    g.add( (data, BDSMAP.key , create_dummy_value()) )
    g.add( (data, BDSMAP.hasArchiver , archiver) )
    
    # attach threshold property
    threshold_data = DATA['meter/threshold/data%d' % counter]
    counter += 1
    threshold_prop = DATA['meter/threshold/property%d' % counter]
    counter += 1
    g.add( (meter, hasPropertyLightingThreshold, threshold_prop) )
    g.add( (threshold_prop, BDSMAP.hasData, threshold_data) )
    g.add( (threshold_data, BDSMAP.uuid, create_dummy_value()) )
    g.add( (threshold_data, BDSMAP.key , create_dummy_value()) )
    g.add( (threshold_data, BDSMAP.hasArchiver , archiver) )

# attach room properties
q = '''
SELECT ?room
WHERE {
    ?room rdf:type/rdfs:subClassOf* brick:Room .
}
'''
rooms = sorted(g.query(q))
for row in rooms:
    room = row[0]
    
    # attach maxOccupant property
    maxocc_data = DATA['room/maxocc/data%d' % counter]
    counter += 1
    maxocc_prop = DATA['room/maxocc/property%d' % counter]
    counter += 1
    g.add( (room, hasPropertyLightingMaxOccupants, maxocc_prop) )
    g.add( (maxocc_prop, BDSMAP.hasData, maxocc_data) )
    g.add( (maxocc_data, BDSMAP.uuid, create_dummy_value()) )
    g.add( (maxocc_data, BDSMAP.key , create_dummy_value()) )
    g.add( (maxocc_data, BDSMAP.hasArchiver , archiver) )

# write output
print('Number of new relations: %u' % (len(g)-initial_relation_count))
g.serialize(ofilename, 'turtle')

